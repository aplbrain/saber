{% extends "base.html" %}

{% block title %}Jobs{% endblock %}

{% block scripts %}
<script>
function download_multiple() {
	// can't get the fetch calls here to work. Response object code 200 but no download.
	var jobs = [];

	document.querySelectorAll("input[type='checkbox']:checked").forEach(item => jobs.push(item.value));

	console.log(jobs);

	var r;
	var fname;
	if (jobs.length == 1) {
		fname = jobs[0] + ".csv";
		r = fetch(`/api/jobs/${jobs[0]}/download`, {method: 'GET'});
	} else {
		fname = "multi-download.csv";
		r = fetch("/api/multi_download", {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({jobs: jobs})});
	}

	// https://stackoverflow.com/questions/3749231/download-file-using-javascript-jquery
	r
	.then(resp => resp.blob())
	.then(blob => {
		const url = window.URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.style.display = 'none';
		a.href = url;
		a.download = fname;
		document.body.appendChild(a);
		a.click();
		window.URL.revokeObjectURL(url);
  	})
  	.catch(() => alert('oh no!'));
}
</script>
{% endblock %}

{% block content %}
<iframe id="download_iframe" style="display:none;"></iframe>
<div class="container">
	<h1>
		Current Jobs
	</h1>
	<table class="table table-bordered shadow-sm">
		<thead class="thead-light">
			<tr>
				<th>Execution Date</th>
				<th>Algorithm</th>
				<th>Experiment</th>
				<th>Status</th>
				<th>Log</th>
				<!--<th>Output</th>-->
				<th>Remove</th>
				<th><button class="btn btn-primary" onclick="return download_multiple()">Download Results</button></th> 
			</tr>
		</thead>
		<tbody>
		{% for job in jobs %}
			<tr>
				<td>{{job["execution_date"]}}</td>
				<td>{{job["docker_image"]}}</td>
				<td>{{job["experiment"]}}</td>
				<td>{{job["status"]}}</td>
				<td>
					<a href="/api/jobs/{{job['job_name']}}/dag/{{job['dag_id']}}/date/{{job['execution_date']}}/log" class="btn btn-secondary" target="_blank">Download Log</a>
				</td>
				<!--<td>
					<a href="/api/jobs/{{job['job_name']}}/download" class="btn btn-primary" target="_blank">Download Job</a>
				</td>-->
				<td>
					<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#modal_{{job['job_name']}}_{{job['date']}}">
						Remove
					</button>
				</td>
				<td class="align-middle text-center p-0 m-0">
					<label class="w-100 h-100 m-0 p-0" for="checkbox_{{job['job_name']}}_{{job['date']}}">
						<input type="checkbox" id="checkbox_{{job['job_name']}}_{{job['date']}}" value="{{job['job_name']}}">
					</label>
				</td>
			</tr>
		{% endfor %}
		</tbody>
	</table>
	{% for job in jobs %}
	<div class="modal fade" id="modal_{{job['job_name']}}_{{job['date']}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Delete {{job['job_name']}} on {{job['date']}}</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<form action="/api/job/{{job['job_name']}}/delete", method="post">
						<button type="submit" class="btn btn-danger">Remove</button>
					</form>
				</div>
			</div>
		</div>
	</div>
	{% endfor %}
</div>
{% endblock %}
